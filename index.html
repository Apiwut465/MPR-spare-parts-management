<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1" />
  <title>MPR Stock Manager</title>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <link rel="stylesheet" href="style.css" />
</head>
<body>

<div class="app">
  <header class="app-header">
    <div class="logo">
      <h1><i class="fa-solid fa-cubes-stacked"></i> MPR STOCK</h1>
      <p>ระบบจัดการอะไหล่ซ่อมบำรุงแผนก MVR&MSR</p>
    </div>
    <button id="btnRefresh" class="btn-icon-soft" title="รีเฟรชข้อมูล">
      <i class="fa-solid fa-rotate-right"></i>
    </button>
  </header>

  <div class="stat-cards">
    <div class="stat-card card-blue">
      <div class="stat-icon"><i class="fa-solid fa-box-open"></i></div>
      <div class="stat-val" id="statTotalParts">0</div>
      <div class="stat-label">รายการอะไหล่ทั้งหมด</div>
    </div>
    <div class="stat-card card-orange">
      <div class="stat-icon"><i class="fa-solid fa-triangle-exclamation"></i></div>
      <div class="stat-val" id="statNearLow">0</div>
      <div class="stat-label">ต้องเติมสต็อก (Low/Min)</div>
    </div>
    <div class="stat-card card-red">
      <div class="stat-icon"><i class="fa-solid fa-circle-xmark"></i></div>
      <div class="stat-val" id="statOut">0</div>
      <div class="stat-label">สินค้าหมด (Out of Stock)</div>
    </div>
  </div>

  <nav class="nav-container">
    <button class="nav-btn active" data-screen="screen-plan">
      <i class="fa-solid fa-clipboard-list"></i> วางแผนสั่งซื้อ
    </button>
    <button class="nav-btn" data-screen="screen-stock">
      <i class="fa-solid fa-boxes-stacked"></i> สต็อกอะไหล่
    </button>
    <button class="nav-btn" data-screen="screen-issue">
      <i class="fa-solid fa-dolly"></i> เบิกอะไหล่
    </button>
    <button class="nav-btn" data-screen="screen-check">
      <i class="fa-solid fa-list-check"></i> รีเช็คสต็อก
    </button>
    <button class="nav-btn" data-screen="screen-history">
      <i class="fa-solid fa-clock-rotate-left"></i> ประวัติ
    </button>
    <button class="nav-btn" data-screen="screen-qr">
      <i class="fa-solid fa-qrcode"></i> พิมพ์ QR
    </button>
  </nav>

  <section id="screen-plan" class="screen active">
    <div class="main-panel">
      <div class="panel-header">
        <h2><i class="fa-solid fa-bell" style="color:#ff7675;"></i> รายการแจ้งเตือน</h2>
        <span style="color:#636e72;">รายการที่ต้องดำเนินการสั่งซื้อทันที</span>
      </div>
      <div id="lowList"></div>
    </div>
  </section>

  <section id="screen-stock" class="screen">
    <div class="main-panel">
      <div class="panel-header">
        <h2><i class="fa-solid fa-layer-group" style="color:#74b9ff;"></i> รายการสต็อกทั้งหมด</h2>
        <div style="display:flex; gap:10px;">
          <select id="exportScope" class="form-select" style="width:auto; padding-top:8px; padding-bottom:8px;">
            <option value="critical">เฉพาะตัวที่ขาด</option>
            <option value="all">ทั้งหมด</option>
          </select>
          <button id="btnExportCsv" class="btn btn-outline"><i class="fa-solid fa-file-csv"></i> Export CSV</button>
        </div>
      </div>
      
      <div class="filter-row">
        <div class="input-group">
          <i class="fa-solid fa-magnifying-glass"></i>
          <input type="text" id="searchInput" class="form-input" placeholder="ค้นหา รหัส, ชื่อ, รุ่น..." />
        </div>
        <select id="statusFilter" class="form-select" style="max-width:200px;">
          <option value="all">สถานะทั้งหมด</option>
          <option value="ok">ปกติ (OK)</option>
          <option value="low">ต่ำกว่า Min</option>
          <option value="out">หมดสต็อก</option>
        </select>
        
        <div style="display:flex; gap:10px;">
            <button class="btn btn-primary" onclick="openPartModal(null)">
              <i class="fa-solid fa-plus"></i> เพิ่มอะไหล่ใหม่
            </button>
            <button class="btn btn-success" id="btnOpenReceive">
              <i class="fa-solid fa-download"></i> รับของเข้า
            </button>
        </div>
      </div>

      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Part ID</th>
              <th>ชื่ออะไหล่</th>
              <th>หมวดหมู่</th>
              <th>รุ่น/ยี่ห้อ</th>
              <th style="text-align:center;">Min</th>
              <th style="text-align:center;">คงเหลือ</th>
              <th>ที่เก็บ</th>
              <th style="text-align:right;">จัดการ</th>
            </tr>
          </thead>
          <tbody id="partsTbody"></tbody>
        </table>
      </div>
    </div>
  </section>

  <section id="screen-issue" class="screen">
    <div class="main-panel">
      <div class="panel-header">
        <h2><i class="fa-solid fa-hand-holding-box" style="color:#00b894;"></i> เบิกจ่ายอะไหล่</h2>
        <button class="btn btn-success" onclick="startQrScan()">
          <i class="fa-solid fa-expand"></i> สแกน QR เบิกของ
        </button>
      </div>

      <div style="background:#f1f2f6; padding:20px; border-radius:15px; margin-bottom:25px;">
        <div class="form-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
          <div>
            <label>ผู้เบิก <span style="color:red">*</span></label>
            <input type="text" id="issueBy" class="form-input" placeholder="ชื่อสกุล" />
          </div>
          <div>
            <label>เครื่องจักร</label>
            <input type="text" id="issueMachine" list="machineList" class="form-input" placeholder="เลือก/พิมพ์" />
            <datalist id="machineList"></datalist>
          </div>
          <div>
            <label>แผนก</label>
            <input type="text" id="issueDept" list="deptList" class="form-input" />
            <datalist id="deptList"></datalist>
          </div>
          <div>
            <label>หมายเหตุ</label>
            <input type="text" id="issueNote" class="form-input" placeholder="-" />
          </div>
        </div>
      </div>

      <div class="filter-row">
        <div class="input-group">
          <i class="fa-solid fa-search"></i>
          <input type="text" id="issueSearch" class="form-input" placeholder="ค้นหาอะไหล่ที่จะเบิก..." />
        </div>
        <select id="issueCategoryFilter" class="form-select" style="max-width:200px;">
          <option value="all">ทุกหมวดหมู่</option>
        </select>
      </div>

      <div id="issueCards" class="card-grid"></div>
    </div>
  </section>

  <section id="screen-check" class="screen">
    <div class="main-panel">
      <div class="panel-header">
        <h2><i class="fa-solid fa-clipboard-check" style="color:#6c5ce7;"></i> รีเช็คสต็อก</h2>
        <div style="display:flex; gap:10px; align-items:center;">
          <input type="date" id="checkDate" class="form-input" style="padding:8px;" />
          <input type="text" id="checkBy" class="form-input" placeholder="ผู้ตรวจนับ" style="width:150px; padding:8px;" />
        </div>
      </div>
      
      <div class="filter-row">
        <div class="input-group">
          <i class="fa-solid fa-search"></i>
          <input type="text" id="checkSearch" class="form-input" placeholder="ค้นหาเพื่อตรวจนับ..." />
        </div>
        <button class="btn btn-outline" onclick="startQrScan()"><i class="fa-solid fa-qrcode"></i> สแกน</button>
      </div>

      <div style="margin-bottom:20px;">
        <div style="display:flex; justify-content:space-between; margin-bottom:5px; font-size:0.9rem;">
          <span>ความคืบหน้า</span>
          <span><span id="checkDone">0</span> / <span id="checkTotal">0</span></span>
        </div>
        <div style="height:8px; background:#dfe6e9; border-radius:4px; overflow:hidden;">
          <div id="checkProgress" style="height:100%; width:0%; background:var(--primary-grad); transition:width 0.3s;"></div>
        </div>
      </div>

      <div id="checkCards" class="card-grid"></div>
    </div>
  </section>

  <section id="screen-history" class="screen">
    <div class="main-panel">
      <div class="panel-header">
        <h2><i class="fa-solid fa-timeline"></i> ประวัติการเคลื่อนไหวล่าสุด</h2>
      </div>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>เวลา</th>
              <th>ประเภท</th>
              <th>Part ID</th>
              <th>จำนวน</th>
              <th>ผู้ทำรายการ</th>
              <th>รายละเอียด</th>
            </tr>
          </thead>
          <tbody id="txnsTbody"></tbody>
        </table>
      </div>
    </div>
  </section>

  <section id="screen-qr" class="screen">
    <div class="main-panel">
      <div class="panel-header">
        <h2><i class="fa-solid fa-print"></i> เลือกอะไหล่พิมพ์ QR Code</h2>
        <button id="btnPrintSelectedQr" class="btn btn-primary">
          <i class="fa-solid fa-print"></i> พิมพ์ที่เลือก (<span id="qrSelectedCount">0</span>)
        </button>
      </div>
      <div class="filter-row">
        <div class="input-group">
          <i class="fa-solid fa-search"></i>
          <input type="text" id="qrSearch" class="form-input" placeholder="ค้นหา..." />
        </div>
        <button id="qrSelectAllVisible" class="btn btn-outline">เลือกทั้งหมด</button>
        <button id="qrClearAll" class="btn btn-outline" style="color:#ff7675; border-color:#ff7675;">ล้าง</button>
      </div>
      <div id="qrSelectList" class="card-grid"></div>
    </div>
  </section>

</div> <div id="partModal" class="modal">
  <div class="modal-backdrop"></div>
  <div class="modal-content">
    <div class="modal-header">
      <h3>จัดการข้อมูลอะไหล่</h3>
      <button class="close-modal"><i class="fa-solid fa-times"></i></button>
    </div>
    
    <form id="formPart">
      <div class="form-grid">
        <div class="form-group">
          <label>Part ID (รหัส)</label>
          <input type="text" id="partPartID" class="form-input" required />
        </div>
        <div class="form-group">
          <label>ชื่ออะไหล่</label>
          <input type="text" id="partName" class="form-input" required />
        </div>
        <div class="form-group">
          <label>หมวดหมู่</label>
          <input type="text" id="partCategory" list="categoryList" class="form-input" />
          <datalist id="categoryList"></datalist>
        </div>
        <div class="form-group">
          <label>ยี่ห้อ</label>
          <input type="text" id="partBrand" class="form-input" />
        </div>
        <div class="form-group">
          <label>รุ่น / Model</label>
          <input type="text" id="partModel" class="form-input" />
        </div>
        <div class="form-group">
          <label>ที่เก็บ (Location)</label>
          <input type="text" id="partLocation" class="form-input" />
        </div>
        <div class="form-group">
          <label>Min (จุดสั่งซื้อ)</label>
          <input type="number" id="partMin" class="form-input" min="0" />
        </div>
        <div class="form-group">
          <label>Qty (คงเหลือ)</label>
          <input type="number" id="partQty" class="form-input" min="0" />
        </div>
        
        <div class="form-group full-width">
          <label>รูปภาพ (URL หรือ อัปโหลด)</label>
          <div style="display:flex; gap:10px; align-items:center;">
             <input type="file" id="partImageFile" class="form-input" accept="image/*" style="flex:1;" />
             <button type="button" id="btnRemoveImg" class="btn btn-outline" style="display:none; color:#ff7675; border-color:#ff7675; padding:8px 15px; white-space:nowrap;">
                <i class="fa-solid fa-trash-can"></i> ลบรูป
             </button>
          </div>
          <input type="hidden" id="partImageURL" />
          <div id="imgPreviewBox" style="margin-top:15px; text-align:center; display:none; background:#f8f9fa; padding:15px; border-radius:12px; border:2px dashed #dfe6e9;">
             <img id="imgPreview" src="" style="max-height:200px; max-width:100%; border-radius:8px;" />
          </div>
        </div>
      </div>
      <div style="text-align:right; margin-top:20px;">
        <button type="submit" class="btn btn-primary">บันทึกข้อมูล</button>
      </div>
    </form>
  </div>
</div>

<div id="receiveModal" class="modal">
  <div class="modal-backdrop"></div>
  <div class="modal-content" style="max-width:500px; overflow:visible;">
    <div class="modal-header">
      <h3 style="color:#00b894;"><i class="fa-solid fa-download"></i> รับของเข้าสต็อก</h3>
      <button class="close-modal"><i class="fa-solid fa-times"></i></button>
    </div>
    
    <form id="formReceive">
      <div class="form-group" style="position:relative;">
        <label>ค้นหาอะไหล่ (พิมพ์ รหัส, ชื่อ หรือ โมเดล)</label>
        
        <input type="text" id="receiveSearchInput" class="form-input" placeholder="พิมพ์เพื่อค้นหา..." autocomplete="off" />
        
        <div id="receiveDropdown" class="custom-dropdown"></div>
        
        <input type="hidden" id="receivePartID" required />
      </div>
      
      <div id="selectedPartInfo" style="display:none; background:#e6fffa; padding:10px; border-radius:8px; border:1px solid #b2f5ea; margin-bottom:15px;">
         <div style="font-weight:bold; color:#00b894;" id="selPartName">-</div>
         <div style="font-size:0.85rem; color:#636e72;">
            ID: <span id="selPartID">-</span> | Model: <span id="selPartModel">-</span>
         </div>
      </div>
      
      <div class="form-group">
        <label>จำนวนที่รับเข้า (+)</label>
        <input type="number" id="receiveQty" class="form-input" min="1" required style="font-size:1.5rem; text-align:center; color:#00b894; font-weight:bold;" />
      </div>
      
      <div style="margin-top:30px;">
        <button type="submit" class="btn btn-success" style="width:100%; justify-content:center; padding:12px;">
           <i class="fa-solid fa-check-circle"></i> ยืนยันรับของ
        </button>
      </div>
    </form>
  </div>
</div>

<div id="qrScanModal" class="modal">
  <div class="modal-backdrop"></div>
  <div class="modal-content" style="max-width:400px; text-align:center;">
    <h3>สแกน QR Code</h3>
    <div class="scanner-ui">
      <video id="qrVideo" playsinline></video>
      <div class="scan-line"></div>
    </div>
    <p>เล็งกล้องไปที่ QR Code ของอะไหล่</p>
    <button class="btn btn-outline close-modal" style="width:100%; justify-content:center;">ยกเลิก</button>
  </div>
</div>

<div id="qrDisplayModal" class="modal">
  <div class="modal-backdrop"></div>
  <div class="modal-content" style="max-width:350px; text-align:center;">
    <div class="modal-header">
      <h3>QR Code</h3>
      <button class="close-modal"><i class="fa-solid fa-times"></i></button>
    </div>
    <div id="qrDisplayArea" style="display:flex; justify-content:center; margin-bottom:20px;"></div>
    <h4 id="qrDisplayTitle"></h4>
    <p id="qrDisplaySub" style="color:#636e72; font-size:0.9rem;"></p>
    <button id="btnInitPrintSingle" class="btn btn-primary" style="width:100%; margin-top:15px; justify-content:center;">
      <i class="fa-solid fa-print"></i> พิมพ์
    </button>
  </div>
</div>

<div id="detailModal" class="modal">
  <div class="modal-backdrop"></div>
  <div class="modal-content">
    <div class="modal-header">
      <h3>รายละเอียดอะไหล่</h3>
      <button class="close-modal"><i class="fa-solid fa-times"></i></button>
    </div>
    <div id="detailBody"></div>
  </div>
</div>

<div id="statusLine">พร้อมทำงาน</div>

<div id="qrPrintArea" style="display:none;"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

<script src="app.js"></script>

</body>
</html>
