<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Spare Parts Stock</title>

  <!-- ฟ้อนต์ Prompt ทั้งเว็บ -->
  <link
    href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap"
    rel="stylesheet"
  />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="app">
    <!-- HEADER -->
    <header class="app-header">
      <div>
        <h1>Spare Parts Stock MPR</h1>
        <p>ระบบจัดการสต็อกอะไหล่สำหรับ Maintenance MPR</p>
      </div>
      <button id="btnRefresh" class="btn btn-outline">รีเฟรชข้อมูล</button>
    </header>

    <!-- DASHBOARD + MAIN TABS -->
    <section class="dashboard">
      <div class="stat-cards">
        <div class="stat-card">
          <div class="stat-label">จำนวนอะไหล่ทั้งหมด</div>
          <div class="stat-value" id="statTotalParts">-</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">รายการที่ต้องสต็อก(ใกล้หมด/ต่ำกว่า Min)</div>
          <div class="stat-value" id="statNearLow">-</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">หมดสต็อก</div>
          <div class="stat-value" id="statOut">-</div>
        </div>
      </div>

      <!-- เมนูหลัก -->
      <nav class="main-tabs">
        <button class="main-tab active" data-screen="screen-plan">
          รายการที่ควรวางแผนสั่งซื้อ
        </button>
        <button class="main-tab" data-screen="screen-stock">
          สต็อกอะไหล่
        </button>
        <button class="main-tab" data-screen="screen-issue">
          เบิกอะไหล่
        </button>
        <button class="main-tab" data-screen="screen-check">
          รีเช็คสต็อก
        </button>
        <button class="main-tab" data-screen="screen-history">
          ประวัติการเคลื่อนไหว
        </button>
        <!-- แท็บสำหรับจัดการพิมพ์ / สแกน QR -->
        <button class="main-tab" data-screen="screen-qr">
          พิมพ์ QR Code
        </button>
      </nav>
    </section>

    <!-- ========== หน้ารายการที่ควรวางแผนสั่งซื้อ ========== -->
    <section id="screen-plan" class="screen active">
      <div class="panel alerts">
        <h2>รายการอะไหล่ที่ควรวางแผนสั่งซื้อ</h2>
        <ul id="lowList"></ul>
      </div>
    </section>

    <!-- ========== หน้า สต็อกอะไหล่ ========== -->
    <section id="screen-stock" class="screen">
      <div class="layout">
        <!-- ตารางสต็อก -->
        <div class="panel parts-panel">
          <div class="panel-header">
            <div>
              <h2>สต็อกอะไหล่</h2>
              <div class="filters">
                <input
                  id="searchInput"
                  type="text"
                  class="filter-input"
                  placeholder="ค้นหาจากรหัส / ชื่อ / โมเดล / ยี่ห้อ"
                />
                <select id="statusFilter" class="filter-select">
                  <option value="all">สถานะทั้งหมด</option>
                  <option value="ok">ปกติ</option>
                  <option value="near">ใกล้หมด</option>
                  <option value="low">ต่ำกว่า Min</option>
                  <option value="out">หมดสต็อก</option>
                </select>
              </div>
            </div>

            <!-- เมนูส่งออก -->
            <div class="export-controls">
              <label for="exportScope" class="export-label">ส่งออกรายการ</label>
              <select id="exportScope" class="filter-select">
                <option value="critical">เฉพาะใกล้หมด / ต่ำกว่า Min / หมดสต็อก</option>
                <option value="out">เฉพาะหมดสต็อก</option>
                <option value="all">ทั้งหมด</option>
              </select>
              <button id="btnExportCsv" class="btn btn-outline btn-sm">ส่งออก CSV</button>
            </div>
          </div>

          <div class="table-wrapper">
            <table class="table">
              <thead>
                <tr>
                  <th>PartID</th>
                  <th>ชื่ออะไหล่</th>
                  <th>หมวดหมู่</th>
                  <th>ยี่ห้อ</th>
                  <th>รุ่น/โมเดล</th>
                  <th>Min</th>
                  <th>คงเหลือ</th>
                  <th>ที่เก็บ</th>
                  <th>จัดการ</th>
                </tr>
              </thead>
              <tbody id="partsTbody"></tbody>
            </table>
          </div>
          <p class="hint">
            * ใช้ช่องค้นหา/ตัวกรองด้านบน และคลิกปุ่ม <strong>จัดการ</strong> หรือ <strong>QR</strong> ในแถวที่ต้องการ
          </p>
        </div>
      </div>
    </section>

    <!-- ========== หน้า เบิกอะไหล่ (การ์ดกริด) ========== -->
    <section id="screen-issue" class="screen">
      <div class="panel issue-panel">
        <div class="panel-header">
          <h2>เบิกอะไหล่</h2>
        </div>

        <!-- แถวค้นหา -->
        <div class="issue-filters">
          <div class="issue-search-row">
            <input
              id="issueSearch"
              type="text"
              class="filter-input"
              placeholder="ค้นหา: รหัส / ชื่อ / หมวดหมู่ / ยี่ห้อ / โมเดล"
            />
<button
  id="btnScanIssue"
  class="btn btn-outline btn-sm"
  onclick="startQrScan()"
>
  สแกน QR
</button>

          </div>
          <div class="issue-filters-row">
            <select id="issueStatusFilter" class="filter-select">
              <option value="all">สถานะทั้งหมด</option>
              <option value="ok">ปกติ</option>
              <option value="near">ใกล้หมด</option>
              <option value="low">ต่ำกว่า Min</option>
              <option value="out">หมดสต็อก</option>
            </select>
            <select id="issueCategoryFilter" class="filter-select">
              <option value="all">ทุกหมวดหมู่</option>
            </select>
          </div>
        </div>

        <!-- ข้อมูลผู้เบิกใช้ร่วมกันทุกการ์ด -->
<div class="issue-meta form">
  <div class="cols-2">
    <div class="form-row">
      <label for="issueBy">ผู้เบิก <span class="req">*</span></label>
      <input
        id="issueBy"
        type="text"
        placeholder="กรอกชื่อผู้เบิก"
        autocomplete="off"
      />
    </div>
    <div class="form-row">
      <label for="issueMachine">เครื่องจักร <span class="req">*</span></label>
      <input
        id="issueMachine"
        type="text"
        list="machineList"
        placeholder="กรอกชื่อเครื่องจักร"
        autocomplete="off"
      />
      <!-- แนะนำชื่อเครื่องจักร (พิมพ์เองได้เลย ไม่ต้องเลือกก็ได้) -->
      <datalist id="machineList"></datalist>
    </div>
  </div>

  <div class="cols-2">
    <div class="form-row">
      <label for="issueDept">แผนก <span class="req">*</span></label>
      <input
        id="issueDept"
        type="text"
        list="deptList"
        placeholder="กรอกชื่อแผนก"
        autocomplete="off"
      />
      <!-- แนะนำชื่อแผนก -->
      <datalist id="deptList"></datalist>
    </div>
    <div class="form-row">
      <label for="issueNote">หมายเหตุ</label>
      <input
        id="issueNote"
        type="text"
        placeholder="ระบุหมายเหตุ (ถ้ามี)"
        autocomplete="off"
      />
    </div>
  </div>
</div>


        <!-- การ์ดอะไหล่ -->
        <div id="issueCards" class="card-grid"></div>
      </div>
    </section>

    <!-- ========== หน้า รีเช็คสต็อก (การ์ดกริด) ========== -->
    <section id="screen-check" class="screen">
      <div class="panel check-panel">
        <div class="panel-header">
          <h2>รีเช็คสต็อก</h2>
          <div class="check-controls">
            <label>
              วันที่รีเช็ค
              <input type="date" id="checkDate" />
            </label>
            <label>
              ผู้เช็ค
              <input type="text" id="checkBy" placeholder="เช่น ช่าง A / ช่าง B" />
            </label>
          </div>
        </div>

        <div class="check-filters">
          <div class="check-search-row">
            <input
              id="checkSearch"
              type="text"
              class="filter-input"
              placeholder="ค้นหา: รหัส / ชื่อ / หมวดหมู่ / ยี่ห้อ / โมเดล"
            />
<button
  id="btnScanCheck"
  class="btn btn-outline btn-sm"
  onclick="startQrScan()"
>
  สแกน QR
</button>

          </div>
        </div>

        <p class="hint">
          ระบบจะถือว่า 1 วันที่เลือก = 1 รอบการรีเช็ค ถ้าอะไหล่ตัวไหนมีบันทึกในวันนั้น
          จะถือว่า "เช็คแล้ว"
        </p>

        <div class="check-progress">
          เช็คแล้ว <span id="checkDone">0</span> / <span id="checkTotal">0</span> รายการ
        </div>

        <!-- การ์ดรีเช็ค -->
        <div id="checkCards" class="card-grid"></div>
      </div>
    </section>

    <!-- ========== หน้า ประวัติการเคลื่อนไหว ========== -->
    <section id="screen-history" class="screen">
      <div class="panel history-panel">
        <div class="panel-header">
          <h2>ประวัติการเคลื่อนไหวสต็อกล่าสุด</h2>
        </div>
        <div class="table-wrapper">
          <table class="table">
            <thead>
              <tr>
                <th>วันที่/เวลา</th>
                <th>ประเภท</th>
                <th>PartID</th>
                <th>จำนวน</th>
                <th>ผู้ทำรายการ</th>
                <th>รายละเอียด</th>
              </tr>
            </thead>
            <tbody id="txnsTbody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- ========== หน้า พิมพ์ QR Code / จัดการรายการพิมพ์ ========== -->
    <section id="screen-qr" class="screen">
      <div class="panel qr-panel">
        <div class="panel-header">
          <h2>เลือกอะไหล่เพื่อพิมพ์ QR</h2>
        </div>

        <div class="qr-select-header">
          <input
            id="qrSearch"
            type="text"
            class="filter-input"
            placeholder="ค้นหา PartID / ชื่อ / รุ่น / ยี่ห้อ / หมวดหมู่"
          />

          <div class="qr-select-actions">
            <div class="qr-select-buttons">
              <button id="qrSelectAllVisible" class="btn btn-outline btn-sm">
                เลือกทั้งหมด (เฉพาะที่แสดง)
              </button>
              <button id="qrClearAll" class="btn btn-outline btn-sm">
                ยกเลิกการเลือกทั้งหมด
              </button>
            </div>
            <span class="qr-select-summary">
              ผลลัพธ์ <span id="qrResultCount">0</span> รายการ • เลือกแล้ว
              <span id="qrSelectedCount">0</span>
            </span>
          </div>
        </div>

        <div id="qrSelectList" class="qr-select-grid"></div>

        <div class="qr-print-actions">
          <button id="btnPrintSelectedQr" class="btn btn-primary">
            พิมพ์ QR ของรายการที่เลือก
          </button>
        </div>
      </div>
    </section>

    <!-- FOOTER -->
    <footer class="app-footer">
      <span id="statusLine" class="status info">พร้อมทำงาน</span>
    </footer>
  </div>

  <!-- ===== Modal ฟอร์มเพิ่ม/แก้ไข & รับเข้าสต็อก ===== -->
  <div id="partModal" class="modal hidden">
    <div class="modal-backdrop"></div>
    <div class="modal-content panel forms-panel">
      <div class="modal-header">
        <h3 class="modal-title">จัดการอะไหล่</h3>
        <button type="button" class="modal-close">×</button>
      </div>

      <div class="tabs">
        <button class="tab active" data-tab="tab-part">เพิ่ม/แก้ไขอะไหล่</button>
        <button class="tab" data-tab="tab-receive">รับเข้าสต็อก</button>
      </div>

      <!-- เพิ่ม/แก้ไขอะไหล่ -->
      <div class="tab-content active" id="tab-part">
        <form id="formPart" class="form">
          <div class="form-row">
            <label for="partPartID">PartID <span class="req">*</span></label>
            <input id="partPartID" type="text" required />
          </div>
          <div class="form-row">
            <label for="partName">ชื่ออะไหล่ <span class="req">*</span></label>
            <input id="partName" type="text" required />
          </div>
          <div class="form-row">
            <label for="partCategory">หมวดหมู่</label>
            <input id="partCategory" type="text" list="categoryList" />
            <datalist id="categoryList"></datalist>
          </div>
          <div class="form-row">
            <label for="partBrand">ยี่ห้อ</label>
            <input id="partBrand" type="text" />
          </div>
          <div class="form-row">
            <label for="partModel">รุ่น/โมเดล</label>
            <input id="partModel" type="text" />
          </div>
          <div class="form-row cols-2">
            <div>
              <label for="partMin">Min</label>
              <input id="partMin" type="number" min="0" value="0" />
            </div>
            <div>
              <label for="partQty">คงเหลือ</label>
              <input id="partQty" type="number" min="0" value="0" />
            </div>
          </div>
          <div class="form-row">
            <label for="partLocation">ที่เก็บ (ชั้น/โซน/กล่อง)</label>
            <input id="partLocation" type="text" />
          </div>
<!-- ซ่อนค่า URL ไว้ให้ JS ใช้ -->
<input type="hidden" id="partImageURL" />

<!-- รูปอะไหล่ -->
<div class="form-row">
  <label for="partImageFile">รูปอะไหล่</label>
  <input
    id="partImageFile"
    type="file"
    accept="image/*"
    capture="environment"
  />
  <small class="hint">เลือกรูปจากเครื่องหรือถ่ายจากกล้องได้เลย</small>
</div>

<!-- พรีวิวรูป (ไม่บังคับ จะใส่หรือไม่ก็ได้) -->
<div class="form-row" id="partImagePreviewRow" style="display:none;">
  <label>พรีวิวรูปอะไหล่</label>
  <img id="partImagePreview" style="max-width:180px;border-radius:10px;" />
</div>


          <div class="form-actions">
            <button type="submit" class="btn">บันทึกอะไหล่</button>
            <button type="button" id="btnClearPart" class="btn btn-secondary">เคลียร์ฟอร์ม</button>
          </div>
          <input type="hidden" id="partImageURL" />


<div class="form-row" id="partImagePreviewRow" style="display:none;">
  <label>พรีวิวรูปอะไหล่</label>
  <img id="partImagePreview" style="max-width:180px;border-radius:10px;" />
</div>

        </form>
      </div>

      <!-- รับเข้าสต็อก -->
      <div class="tab-content" id="tab-receive">
        <form id="formReceive" class="form">
          <div class="form-row">
            <label for="receivePartID">PartID ที่รับเข้า <span class="req">*</span></label>
            <input id="receivePartID" type="text" list="partIdList" required />
            <datalist id="partIdList"></datalist>
          </div>
          <div class="form-row cols-2">
            <div>
              <label for="receiveQty">จำนวนที่รับเข้า <span class="req">*</span></label>
              <input id="receiveQty" type="number" min="1" required />
            </div>
          </div>
          <div class="form-actions">
            <button type="submit" class="btn btn-success">บันทึกรับเข้าสต็อก</button>
            <button type="button" id="btnClearReceive" class="btn btn-secondary">เคลียร์ฟอร์ม</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- ===== Modal รายละเอียดอะไหล่ ===== -->
  <div id="partDetailModal" class="modal hidden">
    <div class="modal-backdrop"></div>
    <div class="modal-content panel">
      <div class="modal-header">
        <h3 class="modal-title">รายละเอียดอะไหล่</h3>
        <button type="button" class="modal-close">×</button>
      </div>
      <div id="partDetailBody" class="part-detail-body"></div>
    </div>
  </div>

  <!-- ===== Modal QR Code สำหรับปริ้น / ดูเดี่ยว ===== -->
  <div id="qrModal" class="modal hidden">
    <div class="modal-backdrop"></div>
    <div class="modal-content panel">
      <div class="modal-header">
        <h3 class="modal-title">QR Code อะไหล่</h3>
        <button type="button" class="modal-close">×</button>
      </div>
      <div id="qrModalBody" class="qr-modal-body"></div>
      <div class="modal-footer">
        <button type="button" id="btnQrPrint" class="btn btn-outline">พิมพ์ QR เฉพาะรายการนี้</button>
      </div>
    </div>
  </div>

  <!-- ===== Modal สแกน QR ด้วยกล้อง ===== -->
  <div id="qrScanModal" class="modal hidden">
    <div class="modal-backdrop"></div>
    <div class="modal-content panel qr-scan-panel">
      <div class="modal-header">
        <h3 class="modal-title">สแกน QR Code</h3>
        <button type="button" class="modal-close">×</button>
      </div>

<div class="qr-scan-body">
  <div class="qr-video-frame">
    <div class="qr-video-inner">
      <video id="qrVideo" autoplay playsinline></video>

      <!-- เส้นวิ่งสแกน -->
      <div class="qr-scan-line"></div>

      <!-- มุมกรอบสแกน 4 มุม -->
      <div class="qr-corner top-left"></div>
      <div class="qr-corner top-right"></div>
      <div class="qr-corner bottom-left"></div>
      <div class="qr-corner bottom-right"></div>
    </div>
  </div>

  <p class="hint qr-scan-hint">
    นำ QR เข้าใกล้กล้องให้ชัด ระบบจะอ่านรหัสและใส่ให้ในช่องค้นหาอัตโนมัติ
  </p>
</div>

<div class="modal-footer qr-scan-footer">
  <button
    type="button"
    id="btnStopScan"
    class="btn btn-secondary modal-close"
  >
    หยุดสแกน / ปิด
  </button>
</div>

    </div>
  </div>

  <!-- พื้นที่ใช้สร้าง QR หลายดวงสำหรับพิมพ์ (ถ้าจะใช้) -->
  <div id="qrPrintArea" class="qr-print-area"></div>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- QRCode JS สำหรับสร้าง QR Code -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <!-- jsQR สำหรับอ่าน/ถอดรหัส QR จากกล้อง -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

  <script>
    window.SUPA = {
      url: 'https://utldpbyewkohuoyhzaat.supabase.co',
      anon: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV0bGRwYnlld2tvaHVveWh6YWF0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNjg4MTIsImV4cCI6MjA3MDc0NDgxMn0.65_11061GKODroeQFB_1vqBR54spYTs8oSgfujhMCoc'
    };
  </script>
  <script src="app.js"></script>
</body>
</html>

